<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ClickUp Task Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
  <div class="max-w-3xl mx-auto p-6 bg-white rounded-lg shadow-md my-10">
    <h1 class="text-2xl font-bold mb-6">ClickUp Task Manager</h1>
    
    <!-- Tabs Navigation -->
    <div class="border-b border-gray-200 mb-6">
      <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="tabNavigation">
        <li class="mr-2">
          <a href="#" class="inline-block p-4 border-b-2 border-blue-600 rounded-t-lg active" 
             id="update-tab" data-tab="update-content">
            Update Tasks
          </a>
        </li>
        <li class="mr-2">
          <a href="#" class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300"
             id="view-tab" data-tab="view-content">
            View Task Status
          </a>
        </li>
        <li class="mr-2">
          <a href="#" class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300"
             id="archive-tab" data-tab="archive-content">
            Archive Tasks
          </a>
        </li>
      </ul>
    </div>
    
    <!-- Error message container -->
    <div id="errorMsg" class="p-3 bg-red-100 text-red-700 rounded-md mb-4 hidden"></div>
    
    <!-- Update Tasks Tab Content -->
    <div id="update-content" class="tab-content">
      <div class="mb-6 p-4 bg-blue-50 rounded-md">
        <h2 class="text-lg font-semibold mb-2">Update Tasks Instructions</h2>
        <ol class="list-decimal ml-5 space-y-1">
          <li>Enter the List ID to fetch available statuses (optional)</li>
          <li>Enter task IDs (one per line or comma-separated)</li>
          <li>Select or enter the new status</li>
          <li>Click "Update Tasks" to process</li>
        </ol>
        <p class="mt-2 text-sm text-blue-800">
          <strong>Note:</strong> For best results with large batches, enter no more than 50 task IDs at once.
        </p>
      </div>
      
      <form id="updateForm" class="space-y-4">
        <div class="flex gap-4">
          <div class="flex-1">
            <label class="block mb-1 font-medium">
              List ID (to fetch statuses):
              <input
                type="text"
                id="listId"
                class="w-full p-2 mt-1 border rounded"
                placeholder="123456789"
              />
            </label>
          </div>
          <div class="flex items-end">
            <button
              type="button"
              id="fetchStatusesBtn"
              class="p-2 bg-gray-200 hover:bg-gray-300 rounded"
            >
              Fetch Statuses
            </button>
          </div>
        </div>

        <div>
          <label class="block mb-1 font-medium">
            Task IDs (one per line or comma-separated):
            <textarea
              id="taskIds"
              class="w-full p-2 mt-1 border rounded h-24"
              placeholder="123456789
987654321
456789123"
              required
            ></textarea>
          </label>
        </div>

        <div id="statusContainer">
          <label class="block mb-1 font-medium">
            New Status:
            <input
              type="text"
              id="customStatus"
              class="w-full p-2 mt-1 border rounded"
              placeholder="e.g., 'in progress', 'completed', etc."
              required
            />
          </label>
        </div>

        <button
          type="submit"
          id="submitBtn"
          class="w-full p-3 bg-blue-600 text-white rounded-md hover:bg-blue-700"
        >
          Update Tasks
        </button>
      </form>

      <div id="updateResultsContainer" class="mt-6 hidden">
        <h2 class="text-lg font-semibold mb-2">Update Results:</h2>
        <div class="border rounded-md overflow-hidden">
          <table class="min-w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="py-2 px-3 text-left">Task ID</th>
                <th class="py-2 px-3 text-left">Status</th>
                <th class="py-2 px-3 text-left">Message</th>
              </tr>
            </thead>
            <tbody id="updateResultsTable" class="divide-y"></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- View Task Status Tab Content -->
    <div id="view-content" class="tab-content hidden">
      <div class="mb-6 p-4 bg-blue-50 rounded-md">
        <h2 class="text-lg font-semibold mb-2">View Task Status Instructions</h2>
        <ol class="list-decimal ml-5 space-y-1">
          <li>Enter task IDs (one per line or comma-separated)</li>
          <li>Click "Get Task Status" to retrieve current status information</li>
        </ol>
      </div>
      
      <form id="viewForm" class="space-y-4">
        <div>
          <label class="block mb-1 font-medium">
            Task IDs (one per line or comma-separated):
            <textarea
              id="viewTaskIds"
              class="w-full p-2 mt-1 border rounded h-24"
              placeholder="123456789
987654321
456789123"
              required
            ></textarea>
          </label>
        </div>

        <button
          type="submit"
          id="viewBtn"
          class="w-full p-3 bg-blue-600 text-white rounded-md hover:bg-blue-700"
        >
          Get Task Status
        </button>
      </form>

      <div id="viewResultsContainer" class="mt-6 hidden">
        <h2 class="text-lg font-semibold mb-2">Task Status Results:</h2>
        <div class="border rounded-md overflow-hidden">
          <table class="min-w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="py-2 px-3 text-left">Task ID</th>
                <th class="py-2 px-3 text-left">Task Name</th>
                <th class="py-2 px-3 text-left">Current Status</th>
                <th class="py-2 px-3 text-left">List</th>
                <th class="py-2 px-3 text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="viewResultsTable" class="divide-y"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Archive Tasks Tab Content -->
    <div id="archive-content" class="tab-content hidden">
      <div class="mb-6 p-4 bg-blue-50 rounded-md">
        <h2 class="text-lg font-semibold mb-2">Archive Tasks Instructions</h2>
        <ol class="list-decimal ml-5 space-y-1">
          <li>Enter a List ID or use the default</li>
          <li>Click "Check Stats" to see current task count</li>
          <li>Set the number of tasks to archive</li>
          <li>Optionally filter to closed tasks only</li>
          <li>Click "Start Archive" to begin</li>
        </ol>
        <p class="mt-2 text-sm text-blue-800">
          <strong>Note:</strong> Tasks are safely saved to MongoDB before being deleted from ClickUp.
        </p>
      </div>

      <!-- Stats Section -->
      <div class="mb-6 p-4 bg-gray-50 rounded-md border">
        <h3 class="font-semibold mb-3">List Statistics</h3>
        <div class="flex gap-4 mb-3">
          <div class="flex-1">
            <label class="block mb-1 font-medium">
              List ID:
              <input
                type="text"
                id="archiveListId"
                class="w-full p-2 mt-1 border rounded"
                placeholder="Enter list ID..."
              />
            </label>
          </div>
          <div class="flex items-end">
            <button
              type="button"
              id="checkStatsBtn"
              class="p-2 bg-gray-200 hover:bg-gray-300 rounded"
            >
              Check Stats
            </button>
          </div>
        </div>
        <div id="statsDisplay" class="hidden">
          <div class="grid grid-cols-3 gap-4 text-center">
            <div class="p-3 bg-white rounded border">
              <div class="text-2xl font-bold text-blue-600" id="statTaskCount">-</div>
              <div class="text-sm text-gray-600">Tasks in List</div>
            </div>
            <div class="p-3 bg-white rounded border">
              <div class="text-2xl font-bold text-green-600" id="statArchivedCount">-</div>
              <div class="text-sm text-gray-600">Already Archived</div>
            </div>
            <div class="p-3 bg-white rounded border">
              <div class="text-2xl font-bold text-gray-600" id="statListName">-</div>
              <div class="text-sm text-gray-600">List Name</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Archive Configuration -->
      <div class="mb-6 space-y-4">
        <div>
          <label class="block mb-1 font-medium">
            Number of tasks to archive:
            <input
              type="number"
              id="archiveCount"
              class="w-full p-2 mt-1 border rounded"
              value="5000"
              min="1"
              max="10000"
            />
          </label>
        </div>
        <div class="flex items-center">
          <input
            type="checkbox"
            id="closedOnlyCheckbox"
            class="mr-2 h-4 w-4"
          />
          <label for="closedOnlyCheckbox" class="font-medium">
            Archive closed/completed tasks only
          </label>
        </div>
        <button
          type="button"
          id="startArchiveBtn"
          class="w-full p-3 bg-red-600 text-white rounded-md hover:bg-red-700"
        >
          Start Archive Process
        </button>
      </div>

      <!-- Progress Section -->
      <div id="archiveProgressSection" class="hidden">
        <h3 class="font-semibold mb-3">Archive Progress</h3>
        <div class="mb-4">
          <div class="w-full bg-gray-200 rounded-full h-4">
            <div id="archiveProgressBar" class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
          <div class="flex justify-between text-sm text-gray-600 mt-1">
            <span id="archiveProgressText">0 / 0 tasks</span>
            <span id="archiveProgressPercent">0%</span>
          </div>
        </div>
        <div class="grid grid-cols-3 gap-4 text-center mb-4">
          <div class="p-2 bg-blue-50 rounded">
            <div class="font-bold" id="progressFetched">0</div>
            <div class="text-xs text-gray-600">Fetched</div>
          </div>
          <div class="p-2 bg-green-50 rounded">
            <div class="font-bold" id="progressSaved">0</div>
            <div class="text-xs text-gray-600">Saved to DB</div>
          </div>
          <div class="p-2 bg-red-50 rounded">
            <div class="font-bold" id="progressDeleted">0</div>
            <div class="text-xs text-gray-600">Deleted</div>
          </div>
        </div>
        <div id="archiveLog" class="bg-gray-900 text-green-400 p-3 rounded font-mono text-xs h-40 overflow-y-auto"></div>
      </div>

      <!-- Results Section -->
      <div id="archiveResultsSection" class="mt-6 hidden">
        <h3 class="font-semibold mb-3">Archive Complete</h3>
        <div class="p-4 bg-green-50 border border-green-200 rounded-md">
          <p class="font-medium text-green-800" id="archiveResultSummary"></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Tab navigation
      const tabs = document.querySelectorAll('[data-tab]');
      tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Update active tab
          tabs.forEach(t => {
            t.classList.remove('active', 'border-blue-600');
            t.classList.add('border-transparent');
          });
          this.classList.add('active', 'border-blue-600');
          this.classList.remove('border-transparent');
          
          // Show active content
          const tabContents = document.querySelectorAll('.tab-content');
          tabContents.forEach(content => {
            content.classList.add('hidden');
          });
          document.getElementById(this.getAttribute('data-tab')).classList.remove('hidden');
        });
      });
      
      // Common elements
      const errorMsg = document.getElementById('errorMsg');
      
      // Update Tasks elements
      const updateForm = document.getElementById('updateForm');
      const listIdInput = document.getElementById('listId');
      const taskIdsInput = document.getElementById('taskIds');
      const customStatusInput = document.getElementById('customStatus');
      const statusContainer = document.getElementById('statusContainer');
      const fetchStatusesBtn = document.getElementById('fetchStatusesBtn');
      const submitBtn = document.getElementById('submitBtn');
      const updateResultsContainer = document.getElementById('updateResultsContainer');
      const updateResultsTable = document.getElementById('updateResultsTable');
      
      // View Task Status elements
      const viewForm = document.getElementById('viewForm');
      const viewTaskIdsInput = document.getElementById('viewTaskIds');
      const viewBtn = document.getElementById('viewBtn');
      const viewResultsContainer = document.getElementById('viewResultsContainer');
      const viewResultsTable = document.getElementById('viewResultsTable');

      // Fetch statuses for update tab
      fetchStatusesBtn.addEventListener('click', async function() {
        const listId = listIdInput.value.trim();

        if (!listId) {
          showError('List ID is required to fetch statuses');
          return;
        }

        try {
          fetchStatusesBtn.textContent = 'Loading...';
          fetchStatusesBtn.disabled = true;

          console.log('Fetching statuses for list:', listId);

          const response = await fetch(`/api/getList?listId=${encodeURIComponent(listId)}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          if (!response.ok) {
            const data = await response.text();
            try {
              // Try to parse as JSON
              const jsonData = JSON.parse(data);
              throw new Error(jsonData.error || jsonData.message || `Error ${response.status}`);
            } catch (e) {
              // If parsing fails, use the raw text
              throw new Error(`Error ${response.status}: ${data.substring(0, 100)}...`);
            }
          }
          
          const data = await response.json();
          
          if (data && data.statuses && data.statuses.length > 0) {
            // Replace the custom status input with a select dropdown
            const select = document.createElement('select');
            select.id = 'statusSelect';
            select.className = 'w-full p-2 mt-1 border rounded';
            select.required = true;
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select a status';
            select.appendChild(defaultOption);
            
            data.statuses.forEach(status => {
              const option = document.createElement('option');
              option.value = status.status;
              option.textContent = status.status;
              select.appendChild(option);
            });
            
            const label = document.createElement('label');
            label.className = 'block mb-1 font-medium';
            label.textContent = 'New Status:';
            label.appendChild(select);
            
            statusContainer.innerHTML = '';
            statusContainer.appendChild(label);
          } else {
            showError('No statuses found for this list');
          }
        } catch (error) {
          showError(`Failed to fetch statuses: ${error.message}`);
        } finally {
          fetchStatusesBtn.textContent = 'Fetch Statuses';
          fetchStatusesBtn.disabled = false;
        }
      });

      // Submit form to update tasks
      updateForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const taskIdsText = taskIdsInput.value.trim();

        // Get status from either select or input
        let status;
        const statusSelect = document.getElementById('statusSelect');
        if (statusSelect) {
          status = statusSelect.value;
        } else {
          status = customStatusInput.value.trim();
        }

        if (!taskIdsText) {
          showError('At least one Task ID is required');
          return;
        }

        if (!status) {
          showError('Please select or enter a status');
          return;
        }

        // Parse task IDs
        const taskIds = taskIdsText.split(/[\n,]+/).map(id => id.trim()).filter(id => id);

        try {
          submitBtn.textContent = 'Updating Tasks...';
          submitBtn.disabled = true;
          hideError();

          // Add progress indicator for large batches
          const taskCount = taskIds.length;
          if (taskCount > 10) {
            showError(`Processing ${taskCount} tasks. This may take a moment...`, 'bg-blue-100 text-blue-700');
          }

          // Process tasks one by one to avoid timeouts
          const MAX_CONCURRENT = 3; // Maximum concurrent requests
          const results = [];
          let processed = 0;

          // Update progress message
          showError(`Processing ${taskCount} tasks. Progress: 0/${taskCount}...`, 'bg-blue-100 text-blue-700');

          // Process in small batches
          for (let i = 0; i < taskIds.length; i += MAX_CONCURRENT) {
            const batch = taskIds.slice(i, i + MAX_CONCURRENT);
            const batchPromises = batch.map(taskId =>
              fetch('/api/processTask', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ taskId, status })
              })
              .then(response => {
                if (!response.ok) {
                  throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
              })
              .then(data => {
                processed++;
                showError(`Processing ${taskCount} tasks. Progress: ${processed}/${taskCount}...`, 'bg-blue-100 text-blue-700');
                return data;
              })
            );
            
            // Wait for current batch to complete
            const batchResults = await Promise.all(batchPromises);
            results.push(...batchResults);
            
            // Add a small delay between batches
            if (i + MAX_CONCURRENT < taskIds.length) {
              await new Promise(resolve => setTimeout(resolve, 300));
            }
          }
          
          // Show completion message
          showError(`All tasks have been updated successfully!`, 'bg-green-100 text-green-700');
          
          // Display results
          updateResultsTable.innerHTML = '';
          results.forEach(result => {
            const row = document.createElement('tr');
            row.className = result.success ? 'bg-green-50' : 'bg-red-50';
            
            const idCell = document.createElement('td');
            idCell.className = 'py-2 px-3';
            idCell.textContent = result.taskId;
            
            const statusCell = document.createElement('td');
            statusCell.className = 'py-2 px-3';
            const statusBadge = document.createElement('span');
            statusBadge.className = result.success 
              ? 'inline-block px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs'
              : 'inline-block px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs';
            statusBadge.textContent = result.success ? 'Success' : 'Failed';
            statusCell.appendChild(statusBadge);
            
            const messageCell = document.createElement('td');
            messageCell.className = 'py-2 px-3';
            messageCell.textContent = result.message;
            
            row.appendChild(idCell);
            row.appendChild(statusCell);
            row.appendChild(messageCell);
            
            updateResultsTable.appendChild(row);
          });
          
          updateResultsContainer.classList.remove('hidden');
        } catch (error) {
          showError(`Failed to update tasks: ${error.message}`);
        } finally {
          submitBtn.textContent = 'Update Tasks';
          submitBtn.disabled = false;
        }
      });
      
      // Submit form to view task status
      viewForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const taskIdsText = viewTaskIdsInput.value.trim();

        if (!taskIdsText) {
          showError('At least one Task ID is required');
          return;
        }

        // Parse task IDs
        const taskIds = taskIdsText.split(/[\n,]+/).map(id => id.trim()).filter(id => id);

        try {
          viewBtn.textContent = 'Fetching...';
          viewBtn.disabled = true;
          hideError();

          const response = await fetch('/api/getTasks', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ taskIds })
          });
          
          if (!response.ok) {
            let errorMessage;
            const responseText = await response.text();
            try {
              // Try to parse the text as JSON
              const errorData = JSON.parse(responseText);
              errorMessage = errorData.message || `HTTP error ${response.status}`;
            } catch (e) {
              // If parsing fails, use the raw text
              errorMessage = `Server error: ${responseText.substring(0, 100)}...`;
            }
            throw new Error(errorMessage);
          }
          
          // Parse the successful response
          const data = JSON.parse(await response.text());
          
          // Display results
          viewResultsTable.innerHTML = '';
          data.results.forEach(task => {
            const row = document.createElement('tr');
            row.className = task.success ? '' : 'bg-red-50';
            
            // Task ID column
            const idCell = document.createElement('td');
            idCell.className = 'py-2 px-3';
            
            // For successful tasks, add clickable link to ClickUp task
            if (task.success && task.url) {
              const link = document.createElement('a');
              link.href = task.url;
              link.target = '_blank';
              link.className = 'text-blue-600 hover:underline';
              link.textContent = task.taskId;
              idCell.appendChild(link);
            } else {
              idCell.textContent = task.taskId;
            }
            
            // Task name column
            const nameCell = document.createElement('td');
            nameCell.className = 'py-2 px-3';
            nameCell.textContent = task.success ? (task.name || 'N/A') : 'Error';
            
            // Status column
            const statusCell = document.createElement('td');
            statusCell.className = 'py-2 px-3';
            
            if (task.success && task.status) {
              const statusBadge = document.createElement('span');
              statusBadge.className = 'inline-block px-2 py-1 rounded text-xs text-white';
              statusBadge.textContent = task.status.status || 'Unknown Status';
              
              // Set background color if available, otherwise use a default
              if (task.status.color) {
                statusBadge.style.backgroundColor = task.status.color;
              } else {
                statusBadge.className += ' bg-gray-500';
              }
              
              statusCell.appendChild(statusBadge);
            } else {
              statusCell.textContent = task.message || 'Failed to fetch status';
            }
            
            // List column
            const listCell = document.createElement('td');
            listCell.className = 'py-2 px-3';
            if (task.success && task.list && task.list.id) {
              const listLink = document.createElement('a');
              listLink.href = `https://app.clickup.com/l/${task.list.id}`;
              listLink.target = '_blank';
              listLink.className = 'text-blue-600 hover:underline';
              listLink.textContent = task.list.name || 'Unknown List';
              listCell.appendChild(listLink);
            } else {
              listCell.textContent = 'N/A';
            }
            
            // Actions column
            const actionsCell = document.createElement('td');
            actionsCell.className = 'py-2 px-3';
            
            if (task.success) {
              // Create copy button
              const copyBtn = document.createElement('button');
              copyBtn.className = 'text-sm bg-gray-200 px-2 py-1 rounded hover:bg-gray-300 mr-2';
              copyBtn.textContent = 'Copy ID';
              copyBtn.onclick = function() {
                navigator.clipboard.writeText(task.taskId).then(() => {
                  copyBtn.textContent = 'Copied!';
                  setTimeout(() => { copyBtn.textContent = 'Copy ID'; }, 2000);
                });
              };
              
              actionsCell.appendChild(copyBtn);
            }
            
            // Add all cells to the row
            row.appendChild(idCell);
            row.appendChild(nameCell);
            row.appendChild(statusCell);
            row.appendChild(listCell);
            row.appendChild(actionsCell);
            
            viewResultsTable.appendChild(row);
          });
          
          viewResultsContainer.classList.remove('hidden');
        } catch (error) {
          if (error.message.includes('timeout')) {
            showError('The request timed out. Please try again with fewer tasks or wait a moment before retrying.');
          } else {
            showError(`Failed to fetch task status: ${error.message}`);
          }
        } finally {
          viewBtn.textContent = 'Get Task Status';
          viewBtn.disabled = false;
        }
      });

      // =====================
      // Archive Tasks Tab
      // =====================
      const archiveListIdInput = document.getElementById('archiveListId');
      const checkStatsBtn = document.getElementById('checkStatsBtn');
      const statsDisplay = document.getElementById('statsDisplay');
      const statTaskCount = document.getElementById('statTaskCount');
      const statArchivedCount = document.getElementById('statArchivedCount');
      const statListName = document.getElementById('statListName');
      const archiveCountInput = document.getElementById('archiveCount');
      const closedOnlyCheckbox = document.getElementById('closedOnlyCheckbox');
      const startArchiveBtn = document.getElementById('startArchiveBtn');
      const archiveProgressSection = document.getElementById('archiveProgressSection');
      const archiveProgressBar = document.getElementById('archiveProgressBar');
      const archiveProgressText = document.getElementById('archiveProgressText');
      const archiveProgressPercent = document.getElementById('archiveProgressPercent');
      const progressFetched = document.getElementById('progressFetched');
      const progressSaved = document.getElementById('progressSaved');
      const progressDeleted = document.getElementById('progressDeleted');
      const archiveLog = document.getElementById('archiveLog');
      const archiveResultsSection = document.getElementById('archiveResultsSection');
      const archiveResultSummary = document.getElementById('archiveResultSummary');

      // Helper to add log entry
      function addLogEntry(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const colors = {
          info: 'text-green-400',
          error: 'text-red-400',
          warning: 'text-yellow-400',
          success: 'text-blue-400'
        };
        const entry = document.createElement('div');
        entry.className = colors[type] || colors.info;
        entry.textContent = `[${timestamp}] ${message}`;
        archiveLog.appendChild(entry);
        archiveLog.scrollTop = archiveLog.scrollHeight;
      }

      // Check Stats button
      checkStatsBtn.addEventListener('click', async function() {
        const listId = archiveListIdInput.value.trim();

        try {
          checkStatsBtn.textContent = 'Loading...';
          checkStatsBtn.disabled = true;
          hideError();

          const url = listId
            ? `/api/getListStats?listId=${encodeURIComponent(listId)}`
            : '/api/getListStats';

          const response = await fetch(url, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || `Error ${response.status}`);
          }

          const data = await response.json();

          // Update stats display
          const countDisplay = data.isPartialCount
            ? `${data.taskCount.toLocaleString()}+`
            : data.taskCount.toLocaleString();
          statTaskCount.textContent = countDisplay;
          statArchivedCount.textContent = data.archivedCount.toLocaleString();
          statListName.textContent = data.listName;
          statsDisplay.classList.remove('hidden');

          // Pre-fill list ID if we got a default
          if (!listId && data.defaultListId) {
            archiveListIdInput.value = data.defaultListId;
          }

          const partialNote = data.isPartialCount ? ' (count is partial due to list size)' : '';
          showError(`Stats loaded for "${data.listName}"${partialNote}`, 'bg-green-100 text-green-700');

        } catch (error) {
          showError(`Failed to fetch stats: ${error.message}`);
        } finally {
          checkStatsBtn.textContent = 'Check Stats';
          checkStatsBtn.disabled = false;
        }
      });

      // Start Archive button
      startArchiveBtn.addEventListener('click', async function() {
        const listId = archiveListIdInput.value.trim();
        const archiveCount = parseInt(archiveCountInput.value) || 5000;
        const closedOnly = closedOnlyCheckbox.checked;

        if (!listId) {
          showError('Please enter a List ID or click "Check Stats" to load the default');
          return;
        }

        // Confirm action
        if (!confirm(`Are you sure you want to archive up to ${archiveCount.toLocaleString()} tasks from this list? This will DELETE them from ClickUp after saving to the archive.`)) {
          return;
        }

        try {
          startArchiveBtn.disabled = true;
          startArchiveBtn.textContent = 'Archiving...';
          hideError();

          // Show progress section
          archiveProgressSection.classList.remove('hidden');
          archiveResultsSection.classList.add('hidden');
          archiveLog.innerHTML = '';

          // Reset progress
          let fetched = 0;
          let saved = 0;
          let deleted = 0;
          let failed = 0;
          let page = 0;
          const BATCH_SIZE = 5; // Tasks per archive batch
          const FETCH_LIMIT = 100; // Tasks per fetch page

          addLogEntry(`Starting archive process for list ${listId}`, 'info');
          addLogEntry(`Target: ${archiveCount} tasks, Closed only: ${closedOnly}`, 'info');

          // Fetch and process tasks in pages
          while (fetched < archiveCount) {
            // Fetch a page of tasks
            addLogEntry(`Fetching page ${page + 1}...`, 'info');

            const fetchUrl = `/api/fetchListTasks?listId=${encodeURIComponent(listId)}&page=${page}&limit=${FETCH_LIMIT}&closedOnly=${closedOnly}`;
            const fetchResponse = await fetch(fetchUrl, {
              method: 'GET',
              headers: { 'Content-Type': 'application/json' }
            });

            if (!fetchResponse.ok) {
              const errorData = await fetchResponse.json();
              throw new Error(errorData.message || `Fetch error ${fetchResponse.status}`);
            }

            const fetchData = await fetchResponse.json();
            const tasks = fetchData.tasks || [];

            if (tasks.length === 0) {
              addLogEntry('No more tasks to fetch', 'warning');
              break;
            }

            addLogEntry(`Fetched ${tasks.length} tasks`, 'success');
            fetched += tasks.length;
            progressFetched.textContent = fetched;

            // Process in smaller batches for archiving
            for (let i = 0; i < tasks.length && (fetched - tasks.length + i) < archiveCount; i += BATCH_SIZE) {
              const batch = tasks.slice(i, Math.min(i + BATCH_SIZE, tasks.length));

              // Only take what we need to meet archiveCount
              const remaining = archiveCount - (fetched - tasks.length + i);
              const batchToProcess = batch.slice(0, remaining);

              if (batchToProcess.length === 0) break;

              addLogEntry(`Archiving batch of ${batchToProcess.length} tasks...`, 'info');

              const archiveResponse = await fetch('/api/archiveBatch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tasks: batchToProcess })
              });

              if (!archiveResponse.ok) {
                const errorData = await archiveResponse.json();
                addLogEntry(`Batch error: ${errorData.message}`, 'error');
                failed += batchToProcess.length;
                continue;
              }

              const archiveData = await archiveResponse.json();

              // Update counters
              archiveData.results.forEach(result => {
                if (result.savedToMongo) saved++;
                if (result.deletedFromClickUp) deleted++;
                if (!result.success) {
                  failed++;
                  addLogEntry(`Failed: ${result.taskId} - ${result.message}`, 'error');
                }
              });

              progressSaved.textContent = saved;
              progressDeleted.textContent = deleted;

              // Update progress bar
              const processed = saved;
              const percent = Math.round((processed / archiveCount) * 100);
              archiveProgressBar.style.width = `${Math.min(percent, 100)}%`;
              archiveProgressText.textContent = `${processed} / ${archiveCount} tasks`;
              archiveProgressPercent.textContent = `${Math.min(percent, 100)}%`;

              addLogEntry(`Batch complete: ${archiveData.successful} archived`, 'success');

              // Small delay between batches
              await new Promise(resolve => setTimeout(resolve, 500));
            }

            // Check if we should continue
            if (!fetchData.hasMore || fetched >= archiveCount) {
              break;
            }

            page++;

            // Delay between pages
            await new Promise(resolve => setTimeout(resolve, 1000));
          }

          // Show results
          addLogEntry(`Archive complete! Saved: ${saved}, Deleted: ${deleted}, Failed: ${failed}`, 'success');
          archiveResultsSection.classList.remove('hidden');
          archiveResultSummary.textContent = `Successfully archived ${saved} tasks. ${deleted} deleted from ClickUp. ${failed > 0 ? `${failed} failed.` : ''}`;

          showError('Archive process complete!', 'bg-green-100 text-green-700');

        } catch (error) {
          addLogEntry(`Error: ${error.message}`, 'error');
          showError(`Archive failed: ${error.message}`);
        } finally {
          startArchiveBtn.disabled = false;
          startArchiveBtn.textContent = 'Start Archive Process';
        }
      });

      // Helper functions
      function showError(message, customClass) {
        errorMsg.textContent = message;

        if (customClass) {
          errorMsg.className = `p-3 rounded-md ${customClass}`;
        } else {
          errorMsg.className = 'p-3 bg-red-100 text-red-700 rounded-md';
        }

        errorMsg.classList.remove('hidden');
      }

      function hideError() {
        errorMsg.textContent = '';
        errorMsg.classList.add('hidden');
      }
    });
  </script>
</body>
</html>